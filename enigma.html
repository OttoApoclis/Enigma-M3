<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Enigma M3 - Combat Secure Edition</title>
    <style>
        /* --- Ê†∏ÂøÉ UI Ê†∑Âºè --- */
        :root { --wood: #3e2723; --panel: #263238; --gold: #ffb74d; --green: #69f0ae; }
        body { background: #121212; color: #eee; font-family: 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .enigma-case { 
            background: var(--wood); 
            background-image: linear-gradient(45deg, #3e2723 25%, #4e342e 25%, #4e342e 50%, #3e2723 50%, #3e2723 75%, #4e342e 75%, #4e342e 100%);
            background-size: 20px 20px;
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.9); 
            border: 6px solid #281912; 
            max-width: 850px; 
        }
        .inner-panel { background: var(--panel); padding: 25px; border-radius: 4px; box-shadow: inset 0 0 20px #000; }
        
        .record-container { display: flex; gap: 15px; margin-bottom: 20px; }
        .record-box { flex: 1; background: #111; border: 2px solid #444; padding: 10px; border-radius: 4px; }
        .record-box label { font-size: 12px; color: #aaa; display: block; margin-bottom: 5px; border-bottom: 1px solid #333; }
        .content { color: var(--green); height: 80px; font-size: 18px; word-break: break-all; letter-spacing: 2px; overflow-y: auto; white-space: pre-wrap; font-weight: bold; text-shadow: 0 0 5px rgba(0, 230, 118, 0.4); }

        .rotor-section { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .rotor-unit { text-align: center; }
        .rotor-val { background: #e0e0e0; color: #000; width: 50px; height: 60px; line-height: 60px; font-size: 32px; font-weight: bold; text-align: center; border-radius: 4px; border: 3px solid #555; margin-bottom: 5px; box-shadow: inset 0 5px 10px rgba(0,0,0,0.3); }

        .grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 10px; margin-bottom: 20px; }
        .lamp { width: 45px; height: 45px; border-radius: 50%; background: #222; border: 2px solid #111; color: #444; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; transition: 0.05s; }
        .lamp.active { background: var(--gold); color: #000; box-shadow: 0 0 25px var(--gold), inset 0 0 10px #fff; border-color: #fff; }
        
        .key { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(145deg, #444, #222); color: #fff; border: 2px solid #555; cursor: pointer; font-size: 16px; box-shadow: 0 5px 0 #000; transition: 0.05s; }
        .key:active { transform: translateY(4px); box-shadow: 0 1px 0 #000; background: #333; }

        .plug-area { background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px dashed #666; margin-top: 15px; }
        .plug-area input { background: #000; color: var(--gold); border: 1px solid #444; padding: 10px; width: 95%; font-family: inherit; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; }

        .btn-group { margin-top: 25px; display: flex; gap: 15px; justify-content: center; }
        button.action-btn { padding: 12px 20px; cursor: pointer; background: #37474f; color: white; border: 1px solid #546e7a; font-family: inherit; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        button.action-btn:hover { background: var(--gold); color: #000; border-color: var(--gold); }

        /* --- ÂÆâÂÖ®ÁîµÊä• PDF Ê†∑Âºè --- */
        @media print {
            body { background: #fff; color: #000; padding: 0; font-family: 'Courier New', Courier, monospace; }
            .enigma-case, .btn-group, h1 { display: none !important; }
            #print-template { display: block !important; width: 100%; max-width: 800px; margin: 0 auto; padding: 40px; border: 2px solid #000; position: relative; }
            
            /* ÁªùÂØÜÂç∞Á´† */
            .stamp { position: absolute; top: 20px; right: 20px; border: 4px double #d32f2f; color: #d32f2f; padding: 5px 10px; font-weight: bold; font-size: 20px; transform: rotate(-10deg); opacity: 0.9; }
            
            .header-main { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
            .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; margin-bottom: 30px; border: 1px solid #000; padding: 10px; }
            
            .msg-body { 
                border: 1px solid #000; 
                padding: 30px; 
                min-height: 200px; 
                font-size: 22px; 
                letter-spacing: 5px; 
                line-height: 2.2; 
                font-weight: bold; 
                word-wrap: break-word;
                font-family: monospace;
            }
            
            .footer-note { margin-top: 20px; font-size: 10px; text-align: center; font-style: italic; }
        }
        #print-template { display: none; }
    </style>
</head>
<body>

<h1>ENIGMA M3 - WEHRMACHT</h1>

<div class="enigma-case">
    <div class="inner-panel">
        <div class="record-container">
            <div class="record-box">
                <label>EINGABE (KLARTEXT)</label>
                <div id="plain-txt" class="content"></div>
            </div>
            <div class="record-box">
                <label>AUSGABE (GEHEIMTEXT)</label>
                <div id="cipher-txt" class="content"></div>
            </div>
        </div>

        <div class="rotor-section">
            <div class="rotor-unit">
                <div id="l-pos" class="rotor-val">A</div>
                <input type="number" id="l-ring" value="0" min="0" max="25" title="Ring" onchange="updateUI()">
            </div>
            <div class="rotor-unit">
                <div id="m-pos" class="rotor-val">A</div>
                <input type="number" id="m-ring" value="0" min="0" max="25" title="Ring" onchange="updateUI()">
            </div>
            <div class="rotor-unit">
                <div id="r-pos" class="rotor-val">A</div>
                <input type="number" id="r-ring" value="0" min="0" max="25" title="Ring" onchange="updateUI()">
            </div>
        </div>

        <div id="lampboard" class="grid"></div>
        <div id="keyboard" class="grid"></div>

        <div class="plug-area">
            <label style="font-size: 12px; color: #aaa;">STECKERBRETT (Êé•Á∫øÊùø): ‰æãÂ¶Ç AB CD EF</label>
            <input type="text" id="plugs" placeholder="ËæìÂÖ•ÈÖçÂØπÂ≠óÊØç..." onkeyup="this.value = this.value.toUpperCase()">
        </div>

        <div class="btn-group">
            <button class="action-btn" onclick="importCipher()">üì• ÂØºÂÖ•/ÊâπÈáè</button>
            <button class="action-btn" onclick="copyCipher()">üìã Â§çÂà∂ÂØÜÊñá</button>
            <button class="action-btn" onclick="printTelegram()">üì° ÂèëÈÄÅÁîµÊä• (PDF)</button>
            <button class="action-btn" onclick="resetAll()" style="color: #ff5252; border-color: #ff5252;">‚ö†Ô∏è ÈîÄÊØÅËÆ∞ÂΩï</button>
        </div>
    </div>
</div>

<div id="print-template">
    <div class="stamp">GEHEIME<br>KOMMANDOSACHE</div>
    
    <div class="header-main">
        <h2>FUNKSPRUCH (RADIO MESSAGE)</h2>
        <p>KRIEGSMARINE / HEER</p>
    </div>

    <div class="meta-grid">
        <div><strong>VON (From):</strong> U-96</div>
        <div><strong>AN (To):</strong> OKM BERLIN</div>
        <div><strong>DATUM (Date):</strong> <span id="p-date"></span></div>
        <div><strong>ZEIT (Time):</strong> <span id="p-time"></span></div>
        <div><strong>GRUPPEN (Count):</strong> <span id="p-count">0</span></div>
        <div><strong>DRINGLICHKEIT:</strong> SSD (Sehr dringend)</div>
        <div style="grid-column: span 2; border-top: 1px solid #000; margin-top: 5px; padding-top: 5px;">
            <strong>SCHL√úSSEL (Key):</strong> [ NUR F√úR OFFIZIERE / OFFICER EYES ONLY ]
        </div>
    </div>

    <div class="msg-body" id="p-content"></div>

    <div class="footer-note">
        WARNING: This document contains encrypted military intelligence. <br>
        Store in a secure location. Destroy upon reading if in danger of capture.
    </div>
</div>

<script>
/** 1. üîâ Èü≥ÊïàÂºïÊìé **/
let audioCtx;
function playClickSound() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle'; 
    osc.frequency.setValueAtTime(300, t);
    osc.frequency.exponentialRampToValueAtTime(50, t + 0.08);
    gain.gain.setValueAtTime(0.3, t);
    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.08);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(t + 0.1);
}

/** 2. ‚öôÔ∏è Enigma Ê†∏ÂøÉ (Â∑≤‰øÆÂ§çÂèåÂêëÂèØÈÄÜÊÄß) **/
const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const ROTORS = {
    I:   { w: "EKMFLGDQVZNTOWYHXUSPAIBRCJ", n: "Q" },
    II:  { w: "AJDKSIRUXBLHWTMCQGZNPYFVOE", n: "E" },
    III: { w: "BDFHJLCPRTXVZNYEIWGAKMUSQO", n: "V" } 
};
const REF_B = "YRUHQSLDPXNGOKMIEBFZCWVJAT";

let state = { l: 0, m: 0, r: 0 };
let count = 0;
const mod = (n, m) => ((n % m) + m) % m;

function enigmaStep(char, silent = false) {
    if (!ALPHABET.includes(char)) return "";
    if (!silent) playClickSound();

    if (state.m === ALPHABET.indexOf(ROTORS.II.n)) {
        state.m = mod(state.m + 1, 26);
        state.l = mod(state.l + 1, 26);
    } else if (state.r === ALPHABET.indexOf(ROTORS.III.n)) {
        state.m = mod(state.m + 1, 26);
    }
    state.r = mod(state.r + 1, 26);
    updateUI();

    const rR = parseInt(document.getElementById('r-ring').value) || 0;
    const mR = parseInt(document.getElementById('m-ring').value) || 0;
    const lR = parseInt(document.getElementById('l-ring').value) || 0;
    const plugStr = document.getElementById('plugs').value.toUpperCase();
    const plugs = {};
    plugStr.split(/[^A-Z]+/).forEach(p => { if(p.length===2){ plugs[p[0]]=p[1]; plugs[p[1]]=p[0]; }});

    let idx = ALPHABET.indexOf(plugs[char] || char);

    const map = (i, rotor, pos, ring, rev = false) => {
        let shift = mod(pos - ring, 26);
        if (!rev) {
            let charAt = rotor.w[mod(i + shift, 26)];
            return mod(ALPHABET.indexOf(charAt) - shift, 26);
        } else {
            let charAt = ALPHABET[mod(i + shift, 26)];
            return mod(rotor.w.indexOf(charAt) - shift, 26);
        }
    };

    idx = map(idx, ROTORS.III, state.r, rR);
    idx = map(idx, ROTORS.II, state.m, mR);
    idx = map(idx, ROTORS.I, state.l, lR);
    idx = ALPHABET.indexOf(REF_B[idx]);
    idx = map(idx, ROTORS.I, state.l, lR, true);
    idx = map(idx, ROTORS.II, state.m, mR, true);
    idx = map(idx, ROTORS.III, state.r, rR, true);

    let res = plugs[ALPHABET[idx]] || ALPHABET[idx];
    count++;
    return res;
}

/** 3. üñ•Ô∏è UI ‰∫§‰∫í **/
function handleInput(k) {
    const res = enigmaStep(k);
    if(res) {
        document.getElementById('L-' + res).classList.add('active');
        const sp = (count % 5 === 0) ? " " : "";
        document.getElementById('plain-txt').innerText += k + sp;
        document.getElementById('cipher-txt').innerText += res + sp;
        const cBox = document.getElementById('cipher-txt');
        cBox.scrollTop = cBox.scrollHeight;
    }
}

function updateUI() {
    document.getElementById('l-pos').innerText = ALPHABET[state.l];
    document.getElementById('m-pos').innerText = ALPHABET[state.m];
    document.getElementById('r-pos').innerText = ALPHABET[state.r];
}

function importCipher() {
    const raw = prompt("Á≤òË¥¥ÂØÜÊñá (ÂøΩÁï•Á¨¶Âè∑):");
    if(!raw) return;
    const clean = raw.toUpperCase().replace(/[^A-Z]/g, '');
    let result = "";
    for(let c of clean) result += enigmaStep(c, true); 
    document.getElementById('plain-txt').innerText = "(IMPORTED)";
    document.getElementById('cipher-txt').innerText = result.replace(/(.{5})/g, '$1 ');
}

// üõ°Ô∏è ÂÆâÂÖ®ÊâìÂç∞ÈÄªËæëÔºöÂè™ÊâìÂç∞ÂØÜÊñáÂíåÂÖÉÊï∞ÊçÆ
function printTelegram() {
    const now = new Date();
    document.getElementById('p-date').innerText = now.toLocaleDateString();
    document.getElementById('p-time').innerText = now.toLocaleTimeString();
    
    // ËÆ°ÁÆóÂ≠óÊØçÊÄªÊï∞Ôºà‰∏çÂê´Á©∫Ê†ºÔºâ
    const cipherRaw = document.getElementById('cipher-txt').innerText.replace(/\s/g, '');
    document.getElementById('p-count').innerText = cipherRaw.length;
    
    // ‰ªÖÂ°´ÂÖÖÂØÜÊñá
    document.getElementById('p-content').innerText = document.getElementById('cipher-txt').innerText;
    
    window.print();
}

window.addEventListener('keydown', (e) => {
    if(e.target.tagName === 'INPUT') return;
    const k = e.key.toUpperCase();
    if(ALPHABET.includes(k) && !e.repeat) handleInput(k);
});
window.addEventListener('keyup', () => document.querySelectorAll('.lamp').forEach(l=>l.classList.remove('active')));

const keys = "QWERTYUIOPASDFGHJKLZXCVBNM".split("");
keys.forEach(k => {
    const l = document.createElement('div');
    l.className = 'lamp'; l.id = 'L-' + k; l.innerText = k;
    document.getElementById('lampboard').appendChild(l);
    const b = document.createElement('button');
    b.className = 'key'; b.innerText = k;
    b.onmousedown = () => handleInput(k);
    b.onmouseup = () => document.querySelectorAll('.lamp').forEach(l=>l.classList.remove('active'));
    document.getElementById('keyboard').appendChild(b);
});

function resetAll() {
    state = { l: 0, m: 0, r: 0 }; count = 0;
    document.getElementById('plain-txt').innerText = "";
    document.getElementById('cipher-txt').innerText = "";
    updateUI();
}

function copyCipher() {
    navigator.clipboard.writeText(document.getElementById('cipher-txt').innerText);
    alert("ÂØÜÊñáÂ∑≤Â§çÂà∂ÔºÅ");
}
</script>
</body>
</html>